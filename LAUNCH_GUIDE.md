# Code Horde — MacBook Launch Guide

## Prerequisites

Before starting, make sure you have these installed:

| Tool | Check command | Install |
|------|--------------|---------|
| **Homebrew** | `brew --version` | `/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"` |
| **Python 3.12+** | `python3 --version` | `brew install python@3.12` |
| **Docker Desktop** | `docker --version` | [Download from docker.com](https://www.docker.com/products/docker-desktop/) |
| **Git** | `git --version` | `brew install git` |
| **ngrok** | `ngrok version` | `brew install ngrok` |

> **Important:** Docker Desktop must be **running** (whale icon in menu bar) before proceeding.

---

## Step 1 — Navigate to the project

```bash
cd /path/to/code-horde
```

## Step 2 — Run first-time setup

```bash
make setup
```

This will:
- Verify all system dependencies
- Create Python virtual environment (`.venv/`)
- Install all Python packages from `pyproject.toml`
- Start Docker infrastructure (Redis, PostgreSQL, RabbitMQ, Neo4j)
- Wait for PostgreSQL to be ready and run `init-db.sql`
- Generate Ed25519 key pairs for all 8 agents (`keys/` folder)
- Generate JWT secret
- Create `.env` from `.env.local` template

## Step 3 — Edit `.env` with your real API keys

Open `.env` in your editor and replace the placeholder values:

```bash
nano .env
# or: code .env / vim .env
```

**Required keys** (the system won't start without these):

```
AGENTARMY_CLAUDE_API_KEY=sk-ant-YOUR_REAL_KEY_HERE
AGENTARMY_SECURITY_JWT_SECRET=<already generated by make setup>
```

**Optional but recommended:**

```
AGENTARMY_OPENAI_API_KEY=sk-YOUR_OPENAI_KEY
AGENTARMY_HF_API_KEY=hf_YOUR_HF_TOKEN
```

**WhatsApp** (skip for now if not ready):

```
AGENTARMY_WHATSAPP_API_TOKEN=YOUR_WHATSAPP_TOKEN
AGENTARMY_WHATSAPP_PHONE_NUMBER_ID=YOUR_PHONE_ID
AGENTARMY_WHATSAPP_VERIFY_TOKEN=any_random_string_you_choose
AGENTARMY_WHATSAPP_WEBHOOK_SECRET=YOUR_WEBHOOK_SECRET
```

If you want to start **without WhatsApp** for now, set:

```
ENABLE_WHATSAPP=false
```

## Step 4 — Install Ollama + local models

```bash
# Install Ollama (if not already installed)
brew install ollama

# Start the Ollama server (keep this terminal open, or run in background)
ollama serve &

# Pull recommended coding model
ollama pull qwen2.5-coder:7b

# Optional: Pull Bielik for Polish language
ollama pull speakleash/bielik-11b-v3.0-instruct
```

Ollama runs **natively** on macOS to leverage Apple Silicon GPU. Not containerized.

## Step 5 — Check infrastructure health

```bash
make status
```

You should see all 4 Docker containers running:

```
aa-redis      Up (healthy)   0.0.0.0:6379->6379/tcp
aa-postgres   Up (healthy)   0.0.0.0:5432->5432/tcp
aa-rabbitmq   Up (healthy)   0.0.0.0:5672->5672/tcp, 0.0.0.0:15672->15672/tcp
aa-neo4j      Up (healthy)   0.0.0.0:7474->7474/tcp, 0.0.0.0:7687->7687/tcp
```

## Step 6 — Launch Code Horde

```bash
make dev
```

This starts the FastAPI app with hot-reload on `http://localhost:8000`.

You'll see logs like:

```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     application_startup_starting
INFO:     initializing_storage_layer
INFO:     initializing_agents
INFO:     application_startup_complete  agents_registered=7
```

## Step 7 — Test the API

Open a **new terminal** and run:

```bash
# Health check
curl http://localhost:8000/health | python3 -m json.tool

# List agents
curl http://localhost:8000/agents | python3 -m json.tool

# Submit a test task
curl -X POST http://localhost:8000/tasks \
  -H "Content-Type: application/json" \
  -d '{"description": "Scan project for security vulnerabilities", "priority": 2, "tags": ["security"]}'
```

## Step 8 — WhatsApp integration (when ready)

### 8a. Open ngrok tunnel

```bash
# In a new terminal:
make tunnel
```

ngrok will display your public URL, something like:

```
Forwarding  https://abc123.ngrok-free.app -> http://localhost:8000
```

### 8b. Configure Meta Developer Console

1. Go to [developers.facebook.com](https://developers.facebook.com/)
2. Select your WhatsApp Business app
3. Go to **WhatsApp > Configuration**
4. Set **Callback URL** to: `https://YOUR-NGROK-DOMAIN.ngrok-free.app/webhook/whatsapp`
5. Set **Verify Token** to the same value as `AGENTARMY_WHATSAPP_VERIFY_TOKEN` in your `.env`
6. Subscribe to: `messages`, `messaging_postbacks`

### 8c. Send a test message

Open WhatsApp and send a message to your Business number:

```
/status
```

Code Horde should respond with system status.

Available WhatsApp commands:
- `/status` — system health
- `/agents` — list active agents
- `/task <description>` — submit a task
- `/help` — show available commands

---

## Quick Reference

| Command | Description |
|---------|-------------|
| `make setup` | First-time setup |
| `make dev` | Start app (hot-reload) |
| `make up` | Start infra + app |
| `make down` | Stop everything |
| `make status` | Check all components |
| `make logs` | Tail Docker logs |
| `make tunnel` | Open ngrok for WhatsApp |
| `make test` | Run test suite |
| `make ollama-setup` | Install Ollama + models |
| `make keys` | Regenerate agent keys |
| `make db-reset` | Reset database |
| `make clean` | Remove all generated data |

## Service URLs

| Service | URL |
|---------|-----|
| Code Horde API | http://localhost:8000 |
| API Health | http://localhost:8000/health |
| API Docs (Swagger) | http://localhost:8000/docs |
| RabbitMQ Management | http://localhost:15672 (agent / agent_local_dev) |
| Neo4j Browser | http://localhost:7474 (neo4j / localdev_neo4j_2026) |
| Ollama | http://localhost:11434 |

## Troubleshooting

**Docker containers won't start:**
- Make sure Docker Desktop is running
- Check port conflicts: `lsof -i :5432` (postgres), `lsof -i :6379` (redis)

**Python import errors:**
- Activate venv: `source .venv/bin/activate`
- Reinstall: `make deps`

**"Settings validation error" on startup:**
- Check `.env` has all required keys (especially `AGENTARMY_CLAUDE_API_KEY`)
- If `ENABLE_WHATSAPP=true`, all WhatsApp fields must be filled

**Ollama model not loading:**
- Check Ollama is running: `curl http://localhost:11434/api/tags`
- Re-pull model: `ollama pull qwen2.5-coder:7b`
